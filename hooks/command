#!/bin/bash

set -euo pipefail

# Determine Dockerfile path
if [[ -n "${BUILDKITE_PLUGINS_PATH:-}" ]]; then
  DOCKERFILE_PATH="$BUILDKITE_PLUGINS_PATH/$BUILDKITE_AGENT_NAME/github-com-aaalaniz-goose-recipe-shortener-git-main/Dockerfile"
else
  DOCKERFILE_PATH="./Dockerfile"
fi

# Build the Docker image
docker build --load -t $BUILDKITE_COMMIT -f "$DOCKERFILE_PATH" .

# Run the shortener with Buildkite plugin environment variables
docker run --rm \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_RECIPE_PATH \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_SHORTENER \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_SHORT_URL_PATH \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_SHORTIO_API_KEY \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_SHORTIO_DOMAIN \
  -e BUILDKITE_PLUGIN_GOOSE_RECIPE_SHORTENER_GIT_CUSTOM_SHORTENER_PATH \
  --workdir /buildkite/workspace \
  -v "$BUILDKITE_BUILD_CHECKOUT_PATH":"/buildkite/workspace" \
  $BUILDKITE_COMMIT buildkite-plugin